# Channels

这部分是作为高频双端 `Events` 的代替品而出现的。

虽然说此处的难度不及 `Events`，但其思想源于 `Events`。

## Events的一个劣势

如果你遇到以下情况，还想用 `Events`，就会很难办：  
1. 两角色交互时存在大量的来回访问。此外，由于没有合适的命名规则，只能使用`~`。而且没有合适的交互方式的话会导致阻塞或者断路。  
2. 异步的情况下希望获得返回值。

`Channels` 可以解决第一点，和一部分第二点。

## 具体思想

由于实现方案没有 `Events` 复杂，我们可以直接探讨 `Channels` 的思想。

`Channels` 需要的：  
区分两个交互的角色为 `S` 和 `C` 。（或任意其他名称）  
`S` 主要负责发布指令以及控制 `Channels` 运行，`C` 主要负责回复指令以及实际触发指令。

二者缺一不可。

由此，我们要新建两个变量 `CHANNEL-S-[identifier]` 和 `CHANNEL-C-[identifier]` 。（具体见[命名规则](../Basical%20Naming%20Rules/index.md)）

`Channels` 基础状态以及其他状态：  
1. `empty`，一般记为 `空` 或不填。主要用于表示不在运行中。  
2. `offline`，一般记为 `-`。主要用于表示运行中或停止接收。  
3. `over`，一般记为 `over`。主要用于表示已完成。
4. 其他，实现你自己的指令。

`Channels` 交互的大致步骤：  
1. `S` 发布 `指令A` 并等待 `指令A` 完成。  
2. `C` 接受 `指令A` 并运行。  
3. `C` 完成，返回内容。  
4. 返回1，或前往5。  
5. `S` 设置结束。`C` 随之结束。

`Channels` 需要注意的：  
1. `S` 端发布的内容需要有指定顺序，与 `C` 端想实现的内容相关。  
2. `C` 端可接收的内容，在未接收内容时无序，接收内容后有序。

具体实现：
...

[点此测试]()

## 大地图移动
前置：`ESB` 架构。

我们将探讨如何优雅而稳定地实现一个大地图移动。
其中，人物强制在格中移动（这会稍加适合我们的架构）。

### 移动

`S` 清空 `channels` 并保持对指令的等待。
在 `C` 端的 `U` 中得到一个合法的操作指令（如 `wsad` 之一，以 `a` 为例，合法代表可以正常行走）。  
从 `U` 返回到 `M`（如利用标准接口 `GUI:result` 返回到 `页面Event`）。  
从 `M` 向 `channels-C` 设置指令，同时进行移动动画，并等待终止。（目前都在 `C` 执行！）
`S` 端发布移动后状态，同时清除 `C` 端指令，告知指令计算完毕。
`C` 得到结果，执行相关动画、效果（不过大部分效果应在 `S` 进行）等。
正常的移动可以不回发指令，此时特判即可直接考虑进行下一次地图上的操作（如移动、交互、菜单）。

### 特殊地面

### NPC

从 `C` 中地图上交互进入此处，向 `S` 发送指令，应返回谈话或NPC的特殊行为。  
个人在 `Story` 系列函数中描述这些行为，表明这是剧情的一部分。

对于特殊情形，如重要NPC，可以用 `GlobalStory`，统一检测他们。（注意命名问题!）

## ...

...

## Multi-Channels 多重频道
这部分可能有一天会开发，但由于我主要使用双角色，大概用不上吧。

注重点：避免多个端同时监听，保证时序的有效性。
